<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transformateur ‚Äî Analyse automatique & remplacements</title>
  <meta name="description" content="Upload ‚Üí Analyse animaux ‚Üí Remplace par (couleur) ‚Üí T√©l√©charge. Style Tokyo Revengers." />
  <style>
    :root{
      --bg:#06060a; --card:#0e0f12; --neon:#ff3b6f; --accent:#00d2ff; --muted:#98a6b3;
      --glass: rgba(255,255,255,0.03);
      --radius:12px;
    }
    *{box-sizing:border-box;font-family:Inter, 'Titillium Web', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;}
    body{margin:0;background:linear-gradient(180deg,#040405 0%, #0b0b0f 100%); color:#e6eef8; -webkit-font-smoothing:antialiased}
    .site{max-width:1000px;margin:28px auto;padding:18px}
    header{display:flex;align-items:center;gap:12px}
    .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(45deg,var(--neon),var(--accent));display:flex;align-items:center;justify-content:center;color:#041015;font-weight:800}
    h1{margin:0;font-size:22px;color:var(--neon);letter-spacing:0.6px}
    p.lead{margin:0;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:16px;margin-top:18px}
    .card{background:var(--card);padding:14px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.03)}
    .muted{color:var(--muted);font-size:13px}
    input[type=file]{display:block;width:100%;padding:10px;border-radius:10px;border:0;background:var(--glass);color:#fff}
    .controls{display:flex;gap:8px;margin-top:10px}
    button{padding:10px 12px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--neon),var(--accent));color:#041015;font-weight:700;cursor:pointer}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    video{width:100%;border-radius:8px;background:#000;margin-top:10px}
    .detected-list{margin-top:12px;display:grid;gap:8px}
    .det-item{display:grid;grid-template-columns:1fr 200px;gap:8px;align-items:center;padding:8px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02))}
    .small{font-size:13px}
    label.small{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input.text,input.color{width:100%;padding:8px;border-radius:8px;border:0;background:rgba(255,255,255,0.02);color:#fff}
    .progress{margin-top:10px;color:#9fd3ff}
    .seo-box{background:#081018;padding:10px;border-radius:8px;margin-top:10px;color:#dbefff}
    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
    .hint{color:#a7b7c6;font-size:13px;margin-top:6px}
  </style>
</head>
<body>
  <div class="site">
    <header>
      <div class="logo">TR</div>
      <div>
        <h1>Transformateur Vid√©o ‚Äî Analyse & remplacements</h1>
        <p class="lead">Upload ‚Üí analyse automatique ‚Üí choisis remplacements & couleurs ‚Üí transforme (dur√©e pr√©serv√©e)</p>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: MAIN WORKFLOW -->
      <div class="card">
        <h3>1 ‚Ä¢ T√©l√©verse ta vid√©o (MP4)</h3>
        <input id="videoUpload" type="file" accept="video/mp4,video/*" />
        <div class="hint">La vid√©o est automatiquement analys√©e pour d√©tecter les animaux d√®s l'upload.</div>

        <div id="previewWrap" style="display:none">
          <label class="small">Pr√©visualisation</label>
          <video id="preview" controls></video>
        </div>

        <div id="analyzeStatus" class="progress" style="display:none"></div>

        <div id="detectedWrap" style="display:none;margin-top:12px">
          <h3>2 ‚Ä¢ Animaux d√©tect√©s</h3>
          <div class="muted small">Pour chaque animal, indique par quoi tu veux le remplacer et la couleur. Laisse vide pour garder l'animal tel quel.</div>
          <div class="detected-list" id="detectedList"></div>

          <div style="margin-top:12px" class="controls">
            <button id="transformBtn">üöÄ Transformer</button>
            <button id="resetBtn" class="secondary">‚Ü∫ R√©initialiser</button>
          </div>

          <div id="transformStatus" class="progress" style="margin-top:8px"></div>
        </div>
      </div>

      <!-- RIGHT: RESULT + SEO -->
      <div class="card">
        <h3>R√©sultat & SEO</h3>
        <div id="resultCard" style="display:none">
          <label class="small">Vid√©o finale</label>
          <video id="resultVideo" controls></video>
          <div style="margin-top:8px"><a id="downloadLink" href="#" download class="small" style="color:var(--accent);text-decoration:none">T√©l√©charger la vid√©o</a></div>

          <div id="seoBox" class="seo-box" style="display:none">
            <div id="seoTitle" style="font-weight:700;color:var(--neon)"></div>
            <div id="seoDesc" class="small" style="margin-top:6px"></div>
            <div style="margin-top:8px"><strong>Hashtags :</strong> <span id="seoTags" class="small"></span></div>
            <div style="margin-top:8px"><strong>Chapitres :</strong><div id="seoChaps" class="small muted"></div></div>
          </div>
        </div>

        <div id="waitingNote" class="muted small" style="margin-top:12px">
          Note : pour que ceci fonctionne il faut un endpoint n8n configur√©. Remplace la variable N8N_WEBHOOK dans le code par ton webhook n8n.
        </div>
      </div>
    </div>

    <footer>¬© Transform ‚Ä¢ Tokyo Revengers UI ‚Äî Assure-toi que ton n8n supporte les actions "analyze", "transform" et "status"</footer>
  </div>

  <script>
    // ---------------------------
    // CONFIG : remplace par ton webhook n8n
    const N8N_WEBHOOK = "https://TON-N8N-INSTANCE/webhook/video-transform"; // <-- remplace ici
    // ---------------------------

    const videoUpload = document.getElementById('videoUpload');
    const previewWrap = document.getElementById('previewWrap');
    const preview = document.getElementById('preview');
    const analyzeStatus = document.getElementById('analyzeStatus');
    const detectedWrap = document.getElementById('detectedWrap');
    const detectedList = document.getElementById('detectedList');
    const transformBtn = document.getElementById('transformBtn');
    const resetBtn = document.getElementById('resetBtn');
    const transformStatus = document.getElementById('transformStatus');
    const resultCard = document.getElementById('resultCard');
    const resultVideo = document.getElementById('resultVideo');
    const downloadLink = document.getElementById('downloadLink');
    const seoBox = document.getElementById('seoBox');
    const seoTitle = document.getElementById('seoTitle');
    const seoDesc = document.getElementById('seoDesc');
    const seoTags = document.getElementById('seoTags');
    const seoChaps = document.getElementById('seoChaps');

    let uploadedFile = null;
    let lastAnalysis = null;
    let pollingInterval = null;

    // Util: create element for each detected animal
    function createDetectedItem(index, label, confidence){
      const wrapper = document.createElement('div');
      wrapper.className = 'det-item';
      // left: info
      const info = document.createElement('div');
      info.innerHTML = `<div style="font-weight:700">${label}</div><div class="small muted">Confiance: ${(confidence*100).toFixed(0)}%</div>`;
      // right: inputs replacement + color
      const controls = document.createElement('div');
      controls.style.display = 'grid';
      controls.style.gridTemplateRows = 'auto auto';
      controls.style.gap = '6px';
      const repl = document.createElement('input');
      repl.className = 'text';
      repl.placeholder = 'Remplacer par (ex: chien, renard...)';
      repl.dataset.label = label;
      repl.dataset.index = index;
      const color = document.createElement('input');
      color.className = 'color';
      color.placeholder = 'Couleur (ex: orange, marron)';
      color.dataset.label = label;
      color.dataset.index = index;
      controls.appendChild(repl);
      controls.appendChild(color);
      wrapper.appendChild(info);
      wrapper.appendChild(controls);
      return wrapper;
    }

    // When user selects a file: preview + auto analyze
    videoUpload.addEventListener('change', async (e)=>{
      const f = e.target.files[0];
      if(!f) return;
      uploadedFile = f;
      preview.src = URL.createObjectURL(f);
      previewWrap.style.display = 'block';
      analyzeStatus.style.display = 'block';
      analyzeStatus.textContent = 'üîç Envoi pour analyse...';
      detectedWrap.style.display = 'none';
      transformStatus.textContent = '';
      resultCard.style.display = 'none';
      seoBox.style.display = 'none';
      // Call n8n analyze action
      try {
        const fd = new FormData();
        fd.append('video', f, f.name);
        fd.append('action', 'analyze'); // indicate analyze intent
        const resp = await fetch(http://localhost:5678/webhook/video-transform + '?action=analyze', { method: 'POST', body: fd });
        if(!resp.ok) throw new Error('Analyse failed');
        const json = await resp.json();
        lastAnalysis = json;
        // expect json.detected = [{label, confidence}, ...] OR fallback
        const detected = Array.isArray(json.detected) ? json.detected : (json.detections || []);
        analyzeStatus.textContent = '‚úÖ Analyse termin√©e ‚Äî animaux d√©tect√©s: ' + (detected.length || 0);
        // build list
        detectedList.innerHTML = '';
        if(detected.length === 0){
          // fallback: propose chat & dog default entries
          const el1 = createDetectedItem(0, 'chat', 0.0);
          const el2 = createDetectedItem(1, 'chien', 0.0);
          detectedList.appendChild(el1);
          detectedList.appendChild(el2);
        } else {
          detected.forEach((d, i)=>{
            // d can be string or object
            let label = (typeof d === 'string') ? d : (d.label || 'animal');
            let conf = (typeof d === 'string') ? 0 : (d.confidence || 0);
            detectedList.appendChild(createDetectedItem(i, label, conf));
          });
        }
        detectedWrap.style.display = 'block';
      } catch(err){
        console.error(err);
        analyzeStatus.textContent = '‚ö†Ô∏è Erreur lors de l\'analyse. V√©rifie ton webhook n8n et r√©essaie.';
      }
    });

    // Reset
    resetBtn.addEventListener('click', ()=>{
      uploadedFile = null;
      videoUpload.value = '';
      preview.pause();
      preview.src = '';
      previewWrap.style.display = 'none';
      detectedWrap.style.display = 'none';
      analyzeStatus.style.display = 'none';
      transformStatus.textContent = '';
      resultCard.style.display = 'none';
      seoBox.style.display = 'none';
    });

    // Transform action: gather replacements, send video + replacements JSON
    transformBtn.addEventListener('click', async ()=>{
      if(!uploadedFile) return alert('Upload une vid√©o d\'abord.');
      transformStatus.textContent = '‚è≥ Upload & pr√©paration du job...';
      // Read all replacement inputs
      const items = detectedList.querySelectorAll('.det-item');
      const replacements = {};
      items.forEach((it)=>{
        const repl = it.querySelector('input.text');
        const color = it.querySelector('input.color');
        const original = repl.dataset.label || repl.placeholder || 'animal';
        const replVal = repl.value.trim();
        const colorVal = color.value.trim();
        if(replVal) replacements[original] = { replace_with: replVal, color: colorVal || null };
      });
      // If replacements empty, warn
      if(Object.keys(replacements).length === 0){
        if(!confirm("Tu n'as renseign√© aucun remplacement. Continuer et garder les animaux ?")) return;
      }
      // build form
      try {
        const fd = new FormData();
        fd.append('video', uploadedFile, uploadedFile.name);
        fd.append('action', 'transform');
        fd.append('replacements', JSON.stringify(replacements));
        // send
        const r = await fetch(N8N_WEBHOOK, { method: 'POST', body: fd });
        if(!r.ok) throw new Error('Envoi transform a √©chou√©');
        const j = await r.json();
        // Expect { status: 'processing', job_id } or { status:'done', download_url, seo }
        if(j.status === 'processing' && j.job_id){
          transformStatus.textContent = 'Job lanc√© (id: ' + j.job_id + '). Traitement en cours...';
          pollJob(j.job_id);
        } else if(j.status === 'done' && j.download_url){
          transformStatus.textContent = '‚úÖ Transformation termin√©e';
          showResult(j);
        } else {
          transformStatus.textContent = 'R√©ponse inattendue du serveur';
          console.log('server response', j);
        }
      } catch(err){
        console.error(err);
        transformStatus.textContent = '‚ö†Ô∏è Erreur lors du lancement de la transformation.';
      }
    });

    // Poll job status
    async function pollJob(jobId){
      const max = 120; // attempts
      const delay = 4000;
      for(let i=0;i<max;i++){
        await new Promise(r=>setTimeout(r,delay));
        try {
          const resp = await fetch(N8N_WEBHOOK + '?action=status&job_id=' + encodeURIComponent(jobId));
          if(!resp.ok) continue;
          const json = await resp.json();
          if(json.status === 'done' && json.download_url){
            transformStatus.textContent = '‚úÖ Traitement termin√©';
            showResult(json);
            return;
          } else {
            transformStatus.textContent = 'Progress: ' + (json.progress || 'processing...');
          }
        } catch(e){
          // ignore, keep polling
        }
      }
      transformStatus.textContent = '‚è±Ô∏è D√©lai d√©pass√© ‚Äî r√©essaie plus tard.';
    }

    // Display final result + SEO
    function showResult(json){
      resultCard.style.display = 'block';
      resultVideo.src = json.download_url;
      downloadLink.href = json.download_url;
      if(json.seo){
        seoBox.style.display = 'block';
        seoTitle.textContent = json.seo.title || '';
        seoDesc.textContent = json.seo.description || '';
        seoTags.textContent = (json.seo.hashtags || []).join(' ');
        seoChaps.innerText = (json.seo.chapters || []).map(c => `${c.time} ${c.label}`).join('  |  ');
      } else {
        seoBox.style.display = 'none';
      }
    }

    // Safety: quick check that webhook chan

